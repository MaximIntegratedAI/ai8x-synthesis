# maxim Integrated OpenOCD target configuration file
# www.maximintegrated.com
# adapter speed
adapter_khz 500
transport select swd
# debug output level
debug_level 2

# reset pin configuration
reset_config srst_only
adapter_nsrst_delay 2
adapter_nsrst_assert_width 2

# jtag scan chain
swd newdap ai85 cpu0 -irlen 4 -irmask 0xf -ircapture 0x1 -expected-id 0x2BA01477

# target configuration
dap create ai85.dap -chain-position ai85.cpu0
target create ai85.cpu0 cortex_m -dap ai85.dap
ai85.cpu0 configure -work-area-phys 0x20005000 -work-area-size 0x2000

# Config Command: flash bank name driver base size chip_width bus_width target [driver_options]
#   flash bank <name> maxim <base> <size> 0 0 <target> <flc base> <sector> <clk> <burst>
#   ai85 flash base address   0x10000000
#   ai85 flash size           0x40000
#   ai85 FLC base address     0x40029000
#   ai85 sector (page) size   0x2000 (8kB)
#   ai85 clock speed          96 (MHz)
flash bank  ai85.flash0 max32xxx 0x10000000 0x80000 0 0 ai85.cpu0 0x40029000 0x2000 20 1

global rom_bp_enabled
set rom_bp_enabled "no"

# Override default init_reset{mode} to catch parameter "mode"
proc init_reset {mode} {
	global sp_reset_mode
	set sp_reset_mode $mode
}

ai85.cpu0 configure -event reset-deassert-post {
  global sp_reset_mode

	if { ([string compare $sp_reset_mode "init"] == 0) } { 
    set state "reset"
    while { [string compare $state "reset"] == 0 } {
      set state [ai85.cpu0 curstate]
      ai85.cpu0 arp_poll
      }
    ai85.cpu0 arp_halt
  }
}

ai85.cpu0 configure -event reset-assert-pre {
  global sp_reset_mode
  global rom_bp_enabled

  if { (([string compare $sp_reset_mode "halt"] == 0) || ([string compare $sp_reset_mode "init"] == 0)) } {
    halt
   	if { ([string compare $rom_bp_enabled "yes"] == 0) } { 
      rbp 0x00002120
      }
    bp 0x00002120 2 hw
    set rom_bp_enabled "yes"
  }
}

ai85.cpu0 configure -event halted {
  global sp_reset_mode
  global rom_bp_enabled

	if { ([string compare $rom_bp_enabled "yes"] == 0) } {
    rbp 0x00002120 
    set rom_bp_enabled "no"
  }
  set sp_reset_mode none
}

